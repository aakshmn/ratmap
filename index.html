<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RatMap v0.2</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script>
    // Disable right-click
    document.addEventListener("contextmenu", function(e) {
      e.preventDefault();
    });
    
    // Initialize app - removed password protection
    window.onload = function () {
      // Initialize the visibility of plate sections based on checkboxes
      updatePlateVisibility();
    };
  </script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --light: #f8f9fa;
      --dark: #212529;
      --success: #4cc9a1;
      --warning: #ffc857;
      --danger: #e63946;
      --gray-100: #f8f9fa;
      --gray-200: #e9ecef;
      --gray-300: #dee2e6;
      --gray-400: #ced4da;
      --gray-500: #adb5bd;
      --gray-600: #6c757d;
      --gray-700: #495057;
      --gray-800: #343a40;
      --gray-900: #212529;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --border-radius: 6px;
      --transition: all 0.2s ease-in-out;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--dark);
      background-color: var(--light);
      line-height: 1.5;
      margin: 0;
      padding: 0;
    }

    .container {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      padding: 0.75rem;
    }

    .top-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .subheader {
      color: var(--gray-700);
      font-size: 0.9rem;
      text-align: left;
      padding: 0.5rem 0;
      flex: 1;
    }

    .subheader strong {
      font-style: normal;
      font-weight: 600;
      color: var(--primary);
    }

    a {
      color: var(--primary);
      text-decoration: none;
      transition: var(--transition);
    }

    a:hover {
      color: var(--primary-light);
      text-decoration: underline;
    }

    h3 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      text-align: center;
      color: var(--secondary);
    }

    /* Card styles */
    .card {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 0.75rem;
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    .card-body {
      padding: 0.75rem;
    }

    /* Controls section */
    .controls-section {
      margin-bottom: 0.75rem;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.5rem;
      align-items: center;
    }

    .control-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .control-item > * {
      min-width: 0;
    }

    .control-item.dropdown {
      flex: 1.5;
    }
    
    .control-item.text-input {
      flex: 3.2;
    }
    
    .control-item.button {
      flex: 0.8;
    }

    .control-label {
      font-size: 0.75rem;
      color: var(--gray-600);
      white-space: nowrap;
      margin-right: 0.1rem;
      min-width: 2rem;
    }

    /* Form controls */
    select, input, button {
      padding: 0.4rem 0.6rem;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-300);
      font-size: 0.9rem;
      transition: var(--transition);
      background-color: white;
      width: 100%;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.4rem 0.6rem;
      border-radius: var(--border-radius);
      font-weight: 500;
      cursor: pointer;
      text-align: center;
      transition: var(--transition);
      border: 1px solid transparent;
      gap: 0.25rem;
      white-space: nowrap;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-light);
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-success {
      background-color: var(--success);
      color: white;
    }

    .btn-success:hover {
      background-color: #36b089;
    }

    .btn-danger {
      background-color: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background-color: #d32f3a;
    }

    .btn-sm {
      font-size: 0.8rem;
      padding: 0.3rem 0.5rem;
    }

    /* Plates selection section - made more compact */
    .plates-selection-section {
      flex: 1;
    }

    .plates-selection-content {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    
    .plates-selection-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-right: 0.5rem;
    }

    .plate-checkbox-label {
      display: inline-flex;
      align-items: center;
      margin-right: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: var(--border-radius);
      background-color: var(--gray-100);
      transition: var(--transition);
      cursor: pointer;
      font-size: 0.8rem;
    }

    .plate-checkbox-label:hover {
      background-color: var(--gray-200);
    }

    .plate-checkbox-label.active {
      background-color: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }

    .plate-checkbox-label input {
      margin-right: 0.3rem;
      width: auto;
    }

    /* Plate containers */
    .plates-container {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .plate-section {
      width: 100%;
      margin-bottom: 1rem;
      display: none; /* Hidden by default, shown based on checkbox selection */
    }

    .plate-section.active {
      display: block;
    }

    .plate-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background-color: rgba(67, 97, 238, 0.05);
      border-bottom: 1px solid var(--gray-200);
    }

    .plate-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--secondary);
      margin: 0;
      flex: 1;
    }

    .plate-wrapper {
      margin-bottom: 1.5rem;
    }
    
    /* Two-column layout for 96-well plates */
    #plate96wContainer {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    
    /* Ensure one column on mobile */
    @media (max-width: 992px) {
      #plate96wContainer {
        grid-template-columns: 1fr;
      }
    }

    .plate-table-container {
      overflow: auto;
      margin-bottom: 0.5rem;
      /* Increased max height by 25% */
      max-height: 1000px;
    }
    
    /* Double max height for 384-well plates */
    #section384w .plate-table-container {
      max-height: 2000px;
    }

    .plateTable {
      border-collapse: collapse;
      width: auto;
      margin-bottom: 0.5rem;
    }

    .plateTable th, .plateTable td {
      /* Increased contrast for gridlines */
      border: 1px solid var(--gray-400);
      min-width: 36px;
      height: 36px;
      text-align: center;
      font-size: 0.7rem;
      padding: 2px;
      white-space: nowrap;
    }

    .plateTable th {
      background-color: var(--gray-100);
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .plateTable th:first-child {
      position: sticky;
      left: 0;
      z-index: 20;
    }

    .plateTable th:hover {
      background-color: var(--gray-200);
    }

    .plateTable td {
      background-color: white;
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
    }

    .plateTable td:hover {
      background-color: rgba(67, 97, 238, 0.05);
    }

    .plateTable .selected {
      background-color: rgba(67, 97, 238, 0.2) !important;
    }

    /* Well content styling */
    .well-id {
      font-weight: bold;
      font-size: 0.65rem;
      color: var(--gray-600);
    }

    .metadata {
      font-size: 0.65rem;
      overflow: visible;
    }

    /* Memory usage */
    #memoryUsage {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: var(--border-radius);
      background-color: var(--gray-100);
      font-size: 0.8rem;
      color: var(--gray-700);
    }

    /* Keyboard Shortcuts Help Popup */
    .shortcuts-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      padding: 1.5rem;
    }
    
    .shortcuts-popup.active {
      display: block;
    }
    
    .shortcuts-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }
    
    .shortcuts-overlay.active {
      display: block;
    }
    
    .shortcuts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .shortcuts-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin: 0;
    }
    
    .shortcuts-close {
      background: none;
      border: none;
      color: var(--gray-600);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
    }
    
    .shortcuts-close:hover {
      color: var(--gray-800);
    }
    
    .shortcuts-section {
      margin-bottom: 1.5rem;
    }
    
    .shortcuts-section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--secondary);
    }
    
    .shortcuts-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .shortcuts-table tr:nth-child(odd) {
      background-color: var(--gray-50);
    }
    
    .shortcuts-table td {
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .shortcuts-table td:first-child {
      font-weight: 500;
      white-space: nowrap;
    }
    
    .key {
      display: inline-block;
      background-color: var(--gray-200);
      border-radius: 4px;
      padding: 0.1rem 0.4rem;
      margin: 0 0.1rem;
      font-size: 0.85rem;
      font-family: monospace;
      box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    }

    /* Export button - more compact */
    .export-btn {
      width: auto;
      min-width: 110px;
    }

    /* Utility */
    .d-flex {
      display: flex;
    }

    .align-center {
      align-items: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .gap-1 {
      gap: 0.25rem;
    }

    .gap-2 {
      gap: 0.5rem;
    }

    .mb-1 {
      margin-bottom: 0.25rem;
    }

    .mb-2 {
      margin-bottom: 0.5rem;
    }

    .grow {
      flex-grow: 1;
    }

    .w-100 {
      width: 100%;
    }

    /* Responsive layout for the controls */
    @media (max-width: 768px) {
      .controls-grid {
        grid-template-columns: 1fr;
      }
      
      .top-section {
        flex-direction: column;
      }
      
      .subheader, .plates-selection-section {
        width: 100%;
      }
    }
    
    /* Prevent user-select during drag operations */
    .plateTable {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Reorganized top section with tagline and plate toggles side by side -->
    <div class="top-section">
      <div class="subheader">
        <strong>RatMap (v0.2).</strong> An opinionated plate mapping tool for filthy festering lab rats. 
        💩🐀 Created by <a href="https://github.com/aakshmn" target="_blank">aakshmn</a>. 
        (<a href="https://github.com/aakshmn/ratmap/blob/main/README.md" target="_blank">README</a>)
      </div>
      
      <!-- Plate Selection Section - moved above assignment controls and made more compact -->
      <div class="plates-selection-section">
        <div class="plates-selection-content">
          <div class="plates-selection-group">
            <label class="plate-checkbox-label" data-plate="P01_96w">
              <input type="checkbox" value="P01_96w" class="plate96wCheckbox"> P01_96w
            </label>
            <label class="plate-checkbox-label" data-plate="P02_96w">
              <input type="checkbox" value="P02_96w" class="plate96wCheckbox"> P02_96w
            </label>
            <label class="plate-checkbox-label" data-plate="P03_96w">
              <input type="checkbox" value="P03_96w" class="plate96wCheckbox"> P03_96w
            </label>
            <label class="plate-checkbox-label" data-plate="P04_96w">
              <input type="checkbox" value="P04_96w" class="plate96wCheckbox"> P04_96w
            </label>
            <label class="plate-checkbox-label" data-plate="P05_96w">
              <input type="checkbox" value="P05_96w" class="plate96wCheckbox"> P05_96w
            </label>
            <label class="plate-checkbox-label" data-plate="P06_96w">
              <input type="checkbox" value="P06_96w" class="plate96wCheckbox"> P06_96w
            </label>
            <label class="plate-checkbox-label" data-plate="P07_96w">
              <input type="checkbox" value="P07_96w" class="plate96wCheckbox"> P07_96w
            </label>
            <label class="plate-checkbox-label" data-plate="P08_96w">
              <input type="checkbox" value="P08_96w" class="plate96wCheckbox"> P08_96w
            </label>
          </div>
          
          <div class="plates-selection-group">
            <label class="plate-checkbox-label" data-plate="P01_384w">
              <input type="checkbox" value="P01_384w" class="plate384wCheckbox"> P01_384w
            </label>
            <label class="plate-checkbox-label" data-plate="P02_384w">
              <input type="checkbox" value="P02_384w" class="plate384wCheckbox"> P02_384w
            </label>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Consolidated Controls Section -->
    <div class="card controls-section">
      <div class="card-body">
        <div class="controls-grid">
          <!-- Layer & Metadata Controls -->
          <div class="control-item dropdown">
            <select id="layerDropdown" title="Select metadata layer"></select>
          </div>
          <div class="control-item button">
            <button id="renameLayerButton" class="btn btn-outline btn-sm">
              <i class="fa fa-pencil"></i> Rename
            </button>
          </div>
          <div class="control-item text-input">
            <input type="text" id="metadataValue" placeholder="Enter value">
          </div>
          <div class="control-item button">
            <button id="assignButton" class="btn btn-primary btn-sm">
              <i class="fa fa-check"></i> Assign
            </button>
          </div>
          <div class="control-item button">
            <button id="clearButton" class="btn btn-outline btn-sm">
              <i class="fa fa-eraser"></i> Clear
            </button>
          </div>
          <div class="control-item button">
            <button id="deselectAllButton" class="btn btn-outline btn-sm">
              <i class="fa fa-eye"></i> Visualize
            </button>
          </div>
          
          <!-- Mapping Controls -->
          <div class="control-item dropdown">
            <span class="control-label">Src</span>
            <select id="srcPlateSelect"></select>
          </div>
          <div class="control-item dropdown">
            <span class="control-label">Dest</span>
            <select id="destQuadSelect"></select>
          </div>
          <div class="control-item button">
            <button id="mapButton" class="btn btn-primary btn-sm">
              <i class="fa fa-exchange-alt"></i> Map
            </button>
          </div>
          <div class="control-item button">
            <button id="undoButton" class="btn btn-outline btn-sm">
              <i class="fa fa-undo"></i> Undo
            </button>
          </div>
          <div class="control-item button">
            <button id="clearAllButton" class="btn btn-danger btn-sm">
              <i class="fa fa-trash-alt"></i> Empty 🤮
            </button>
          </div>
          <div class="control-item">
            <span id="memoryUsage">(0 KB)</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Plates Container -->
    <div class="plates-container">
      <!-- 96-well Plates Section - modified header -->
      <div class="plate-section" id="section96w">
        <div class="card">
          <div class="plate-header">
            <h2 class="plate-title">96-well Plates</h2>
            <button id="export96Button" class="btn btn-success btn-sm export-btn">
              <i class="fa fa-file-export"></i> Export 🧀
            </button>
          </div>
          <div class="card-body">
            <div id="plate96wContainer"></div>
          </div>
        </div>
      </div>
      
      <!-- 384-well Plates Section - modified header -->
      <div class="plate-section" id="section384w">
        <div class="card">
          <div class="plate-header">
            <h2 class="plate-title">384-well Plates</h2>
            <button id="export384Button" class="btn btn-success btn-sm export-btn">
              <i class="fa fa-file-export"></i> Export 🧀
            </button>
          </div>
          <div class="card-body">
            <div id="plate384wContainer"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Keyboard Shortcuts Popup -->
  <div class="shortcuts-overlay" id="shortcutsOverlay"></div>
  <div class="shortcuts-popup" id="shortcutsPopup">
    <div class="shortcuts-header">
      <h3 class="shortcuts-title">Keyboard Shortcuts</h3>
      <button class="shortcuts-close" id="shortcutsClose">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="shortcuts-section">
      <h4 class="shortcuts-section-title">General Controls</h4>
      <table class="shortcuts-table">
        <tr>
          <td><span class="key">Ctrl</span> + <span class="key">Shift</span> + <span class="key">L</span> or <span class="key">M</span></td>
          <td>Focus and select the metadata value input</td>
        </tr>
        <tr>
          <td><span class="key">Ctrl</span> + <span class="key">Shift</span> + <span class="key">S</span></td>
          <td>Focus the Source dropdown</td>
        </tr>
        <tr>
          <td><span class="key">Ctrl</span> + <span class="key">Shift</span> + <span class="key">D</span></td>
          <td>Focus the Destination dropdown</td>
        </tr>
        <tr>
          <td><span class="key">Ctrl</span> + <span class="key">Shift</span> + <span class="key">O</span></td>
          <td>Focus the 96-well plates Export button</td>
        </tr>
        <tr>
          <td><span class="key">Ctrl</span> + <span class="key">Shift</span> + <span class="key">P</span></td>
          <td>Focus the 384-well plates Export button</td>
        </tr>
        <tr>
          <td><span class="key">Ctrl</span> + <span class="key">/</span></td>
          <td>Toggle this shortcuts help (Mac: <span class="key">⌘</span> + <span class="key">/</span>)</td>
        </tr>
        <tr>
          <td><span class="key">Esc</span></td>
          <td>Close shortcuts help popup</td>
        </tr>
      </table>
    </div>
    
    <div class="shortcuts-section">
      <h4 class="shortcuts-section-title">Plate Toggling</h4>
      <table class="shortcuts-table">
        <tr>
          <td><span class="key">Ctrl</span> + <span class="key">Alt</span> + <span class="key">1</span> - <span class="key">8</span></td>
          <td>Toggle 96-well plates P01 through P08 (Mac: <span class="key">⌘</span> + <span class="key">Option</span>)</td>
        </tr>
        <tr>
          <td><span class="key">Ctrl</span> + <span class="key">Alt</span> + <span class="key">9</span> - <span class="key">0</span></td>
          <td>Toggle 384-well plates P01 and P02 (Mac: <span class="key">⌘</span> + <span class="key">Option</span>)</td>
        </tr>
        <tr>
          <td><span class="key">Ctrl</span> + <span class="key">Alt</span> + <span class="key">Shift</span> + <span class="key">1</span> - <span class="key">0</span></td>
          <td>Select all wells in the corresponding plate (Mac: <span class="key">⌘</span> + <span class="key">Option</span> + <span class="key">Shift</span>)</td>
        </tr>
      </table>
    </div>
    
    <div class="shortcuts-section">
      <h4 class="shortcuts-section-title">Metadata Assignment</h4>
      <table class="shortcuts-table">
        <tr>
          <td><span class="key">Enter</span></td>
          <td>Assign value to selected well(s) in column-major order</td>
        </tr>
        <tr>
          <td><span class="key">Shift</span> + <span class="key">Enter</span></td>
          <td>Assign value to selected well(s) in row-major order</td>
        </tr>
        <tr>
          <td><span class="key">Shift</span> + <span class="key">Alt</span> + <span class="key">Enter</span></td>
          <td>Rename the current layer (Mac: <span class="key">Shift</span> + <span class="key">Option</span> + <span class="key">Enter</span>)</td>
        </tr>
      </table>
    </div>
  </div>
  
  <script>
    /***** Global Data & Layer Names *****/
    let plate96wData = {};
    let plate384wData = {};
    let lastState = null; // for one-level undo
    let isMetadataOverlayMode = false; // Track whether we're showing the metadata overlay

    // Global variable to control well advancement order.
    let advanceOrder = "column";

    // Maintain an array of layer names.
    let layerNames = ["Metadata_1", "Metadata_2", "Metadata_3", "Metadata_4", "Metadata_5", "Metadata_6", "Metadata_7", "Metadata_8", "Metadata_9"];

    // Define rows and columns.
    const rows96 = ['A','B','C','D','E','F','G','H'];
    const cols96 = Array.from({length: 12}, (_, i) => String(i+1).padStart(2, '0'));
    const rows384 = "ABCDEFGHIJKLMNOP".split('');
    const cols384 = Array.from({length: 24}, (_, i) => String(i+1).padStart(2, '0'));

    /***** Utility: Update Layer Dropdown *****/
    function updateLayerDropdowns() {
      const dropdown = document.getElementById("layerDropdown");
      dropdown.innerHTML = "";
      for (let i = 0; i < layerNames.length; i++) {
        let optionText = (i+1) + ". " + layerNames[i];
        let opt = document.createElement("option");
        opt.value = "metadata_" + (i+1);
        opt.textContent = optionText;
        dropdown.appendChild(opt);
      }
    }
    updateLayerDropdowns();
    
    // Add change event to layer dropdown to update visualization if active
    document.getElementById("layerDropdown").addEventListener("change", function() {
      if (isMetadataOverlayMode) {
        applyMetadataVisualization();
      }
    });

    /***** Undo Functions *****/
    function saveUndoState() {
      lastState = {
        plate96wData: JSON.parse(JSON.stringify(plate96wData)),
        plate384wData: JSON.parse(JSON.stringify(plate384wData))
      };
    }
    function undoLastAction() {
      if (!lastState) {
        alert("Nothing to undo.");
        return;
      }
      plate96wData = JSON.parse(JSON.stringify(lastState.plate96wData));
      plate384wData = JSON.parse(JSON.stringify(lastState.plate384wData));
      lastState = null;
      updateAllDisplayedCells();
      document.querySelectorAll("th.selected").forEach(el => el.classList.remove("selected"));
      updateRatCache();
    }

    /***** Initialization Functions for Plates *****/
    function initPlate96(plateId) {
      let data = {};
      rows96.forEach(r => {
        cols96.forEach(c => {
          let wellId = r + c;
          let wellData = {};
          for (let i = 1; i <= 9; i++) {
            wellData["metadata_" + i] = "";
          }
          data[wellId] = wellData;
        });
      });
      plate96wData[plateId] = data;
    }
    function initPlate384(plateId) {
      let data = {};
      rows384.forEach(r => {
        cols384.forEach(c => {
          let wellId = r + c;
          let wellData = {};
          for (let i = 1; i <= 9; i++) {
            wellData["metadata_" + i] = "";
          }
          wellData.Src_Plate_96w = "";
          wellData.Src_Well_96w = "";
          data[wellId] = wellData;
        });
      });
      plate384wData[plateId] = data;
    }

    /***** Plate Table Generation *****/
    function generate96PlateTable(plateId) {
      let table = document.createElement("table");
      table.className = "plateTable";
      table.setAttribute("data-plate", plateId);
      let thead = document.createElement("thead");
      let headerRow = document.createElement("tr");
      let topLeft = document.createElement("th");
      topLeft.className = "select-all";
      topLeft.textContent = "";
      headerRow.appendChild(topLeft);
      cols96.forEach(col => {
        let th = document.createElement("th");
        th.textContent = col;
        th.setAttribute("data-col", col);
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      let tbody = document.createElement("tbody");
      rows96.forEach(row => {
        let tr = document.createElement("tr");
        let th = document.createElement("th");
        th.textContent = row;
        th.setAttribute("data-row", row);
        tr.appendChild(th);
        cols96.forEach(col => {
          let td = document.createElement("td");
          let wellId = row + col;
          td.className = "well";
          td.setAttribute("data-well", wellId);
          td.setAttribute("data-plate", plateId);
          updateCellDisplay96(td, plateId, wellId);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      return table;
    }
    function generate384PlateTable(plateId) {
      let table = document.createElement("table");
      table.className = "plateTable";
      table.setAttribute("data-plate", plateId);
      let thead = document.createElement("thead");
      let headerRow = document.createElement("tr");
      let topLeft = document.createElement("th");
      topLeft.className = "select-all";
      topLeft.textContent = "";
      headerRow.appendChild(topLeft);
      cols384.forEach(col => {
        let th = document.createElement("th");
        th.textContent = col;
        th.setAttribute("data-col", col);
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      let tbody = document.createElement("tbody");
      rows384.forEach(row => {
        let tr = document.createElement("tr");
        let th = document.createElement("th");
        th.textContent = row;
        th.setAttribute("data-row", row);
        tr.appendChild(th);
        cols384.forEach(col => {
          let td = document.createElement("td");
          let wellId = row + col;
          td.className = "well";
          td.setAttribute("data-well", wellId);
          td.setAttribute("data-plate", plateId);
          updateCellDisplay384(td, plateId, wellId);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      return table;
    }

    /***** Display Update Functions *****/
    function updateCellDisplay96(cell, plateId, wellId) {
      let data = plate96wData[plateId][wellId];
      let html = `<div class="well-id">${wellId}</div>`;
      for (let i = 1; i <= 9; i++) {
        let key = "metadata_" + i;
        if (data[key]) {
          html += `<div class="metadata">${i}: ${data[key]}</div>`;
        }
      }
      cell.innerHTML = html;
    }
    function updateCellDisplay384(cell, plateId, wellId) {
      let data = plate384wData[plateId][wellId];
      let html = `<div class="well-id">${wellId}</div>`;
      for (let i = 1; i <= 9; i++) {
        let key = "metadata_" + i;
        if (data[key]) {
          html += `<div class="metadata">${i}: ${data[key]}</div>`;
        }
      }
      if (data.Src_Plate_96w || data.Src_Well_96w) {
        html += `<div class="metadata">Map: ${data.Src_Plate_96w} ${data.Src_Well_96w}</div>`;
      }
      cell.innerHTML = html;
    }
    function updateAllDisplayedCells() {
      document.querySelectorAll("td.well").forEach(cell => {
        let plateId = cell.getAttribute("data-plate");
        let wellId = cell.getAttribute("data-well");
        if (plateId.includes("96w")) {
          updateCellDisplay96(cell, plateId, wellId);
        } else {
          updateCellDisplay384(cell, plateId, wellId);
        }
      });
    }

    /***** Selection and Visualization Handlers *****/
    function clearHeaderSelections() {
      document.querySelectorAll("th.selected").forEach(el => el.classList.remove("selected"));
    }
    
    function clearAllSelections() {
      document.querySelectorAll("td.well.selected, th.selected").forEach(el => el.classList.remove("selected"));
    }
    
    // Exit metadata overlay mode and return to normal selection mode
    function exitMetadataOverlayMode() {
      if (isMetadataOverlayMode) {
        isMetadataOverlayMode = false;
        document.querySelectorAll("td.well").forEach(cell => {
          cell.style.backgroundColor = "";
        });
        
        // Update the button text
        const deselectAllButton = document.getElementById("deselectAllButton");
        deselectAllButton.innerHTML = '<i class="fa fa-eye"></i> Visualize';
      }
    }
    
    // Generate a color from a gradient based on index and total
    function getGradientColor(index, total) {
      // Define gradient stops with pastel colors
      const colors = [
        [173, 216, 230],    // Pastel blue
        [221, 160, 221],    // Pastel purple
        [255, 182, 193],    // Pastel pink
        [255, 218, 185],    // Pastel peach
        [255, 255, 153],    // Pastel yellow
        [144, 238, 144]     // Pastel green
      ];
      
      // Calculate position in the gradient
      const position = (index / (total - 1 || 1)) * (colors.length - 1);
      
      // Find the two colors to interpolate between
      const lowerIndex = Math.floor(position);
      const upperIndex = Math.min(colors.length - 1, lowerIndex + 1);
      
      // Calculate interpolation factor
      const factor = position - lowerIndex;
      
      // Interpolate between the two colors
      const r = Math.round(colors[lowerIndex][0] + factor * (colors[upperIndex][0] - colors[lowerIndex][0]));
      const g = Math.round(colors[lowerIndex][1] + factor * (colors[upperIndex][1] - colors[lowerIndex][1]));
      const b = Math.round(colors[lowerIndex][2] + factor * (colors[upperIndex][2] - colors[lowerIndex][2]));
      
      return `rgb(${r}, ${g}, ${b})`;
    }
    
    // Apply metadata visualization overlay
    function applyMetadataVisualization() {
      clearAllSelections();
      isMetadataOverlayMode = true;
      
      // Get the current metadata layer
      const layer = document.getElementById("layerDropdown").value;
      
      // Collect all distinct non-empty values for this layer across visible plates
      const distinctValues = new Set();
      
      // First, collect all values
      // 96-well plates
      getVisiblePlate96Ids().forEach(plateId => {
        const plate = plate96wData[plateId];
        for (const wellId in plate) {
          const value = plate[wellId][layer];
          if (value && value.trim() !== "") {
            distinctValues.add(value);
          }
        }
      });
      
      // 384-well plates
      getVisiblePlate384Ids().forEach(plateId => {
        const plate = plate384wData[plateId];
        for (const wellId in plate) {
          const value = plate[wellId][layer];
          if (value && value.trim() !== "") {
            distinctValues.add(value);
          }
        }
      });
      
      // Sort values (numerical or alphabetical)
      const sortedValues = Array.from(distinctValues).sort((a, b) => {
        // Try to compare as numbers first
        const numA = parseFloat(a);
        const numB = parseFloat(b);
        if (!isNaN(numA) && !isNaN(numB)) {
          return numA - numB;
        }
        // Otherwise compare as strings
        return a.localeCompare(b);
      });
      
      // Create a mapping from values to colors
      const colorMap = {};
      sortedValues.forEach((value, index) => {
        colorMap[value] = getGradientColor(index, sortedValues.length);
      });
      
      // Apply colors to all visible wells
      // 96-well plates
      getVisiblePlate96Ids().forEach(plateId => {
        const plate = plate96wData[plateId];
        for (const wellId in plate) {
          const cell = document.querySelector(`td.well[data-plate="${plateId}"][data-well="${wellId}"]`);
          const value = plate[wellId][layer];
          if (cell && value && value.trim() !== "") {
            cell.style.backgroundColor = colorMap[value];
          } else if (cell) {
            cell.style.backgroundColor = "";
          }
        }
      });
      
      // 384-well plates
      getVisiblePlate384Ids().forEach(plateId => {
        const plate = plate384wData[plateId];
        for (const wellId in plate) {
          const cell = document.querySelector(`td.well[data-plate="${plateId}"][data-well="${wellId}"]`);
          const value = plate[wellId][layer];
          if (cell && value && value.trim() !== "") {
            cell.style.backgroundColor = colorMap[value];
          } else if (cell) {
            cell.style.backgroundColor = "";
          }
        }
      });
      
      // Update the button text
      const deselectAllButton = document.getElementById("deselectAllButton");
      deselectAllButton.innerHTML = '<i class="fa fa-th"></i> Hide Viz';
    }

    function addSelectionHandlers(table) {
      // Track mouse state for drag selection
      let isDragging = false;
      let startCell = null;
      let startWasSelected = false;
      let lastHoveredCell = null;
      
      // Add handler to exit metadata overlay mode on well clicks
      table.querySelectorAll("td.well, th").forEach(cell => {
        cell.addEventListener("mousedown", function(event) {
          if (isMetadataOverlayMode) {
            exitMetadataOverlayMode();
            // Don't proceed with selection on this click - requires a new click
            event.preventDefault();
            event.stopPropagation();
            return false;
          }
        }, true); // Use capturing phase
      });
      
      // Helper function to get all cells in a rectangle between two cells
      function getCellsInRectangle(cell1, cell2) {
        let plateId = cell1.getAttribute("data-plate");
        let well1 = cell1.getAttribute("data-well");
        let well2 = cell2.getAttribute("data-well");
        
        let rows, cols;
        if (plateId.includes("96w")) { 
          rows = rows96; 
          cols = cols96; 
        } else { 
          rows = rows384; 
          cols = cols384; 
        }
        
        let match1 = well1.match(/^([A-Z]+)([0-9]+)$/);
        let match2 = well2.match(/^([A-Z]+)([0-9]+)$/);
        
        if (!match1 || !match2) return [];
        
        let startRow = match1[1], startCol = match1[2];
        let endRow = match2[1], endCol = match2[2];
        let startRowIndex = rows.indexOf(startRow);
        let endRowIndex = rows.indexOf(endRow);
        let startColIndex = cols.indexOf(startCol);
        let endColIndex = cols.indexOf(endCol);
        
        // Ensure start indices are <= end indices
        let minRowIndex = Math.min(startRowIndex, endRowIndex);
        let maxRowIndex = Math.max(startRowIndex, endRowIndex);
        let minColIndex = Math.min(startColIndex, endColIndex);
        let maxColIndex = Math.max(startColIndex, endColIndex);
        
        // Get all cells in the rectangle
        let cellsInRect = [];
        for (let r = minRowIndex; r <= maxRowIndex; r++) {
          for (let c = minColIndex; c <= maxColIndex; c++) {
            let rowLetter = rows[r];
            let colNumber = cols[c];
            let wellId = rowLetter + colNumber;
            let cell = table.querySelector(`td.well[data-plate="${plateId}"][data-well="${wellId}"]`);
            if (cell) {
              cellsInRect.push(cell);
            }
          }
        }
        
        return cellsInRect;
      }
      
      // Add mousedown, mousemove, and mouseup events to each well cell
      table.querySelectorAll("td.well").forEach(cell => {
        // Handle initial mouse down on a cell
        cell.addEventListener("mousedown", function(event) {
          // Prevent text selection during drag
          event.preventDefault();
          
          // If this is a right-click, don't start dragging
          if (event.button === 2) return;
          
          // Start dragging
          isDragging = true;
          startCell = cell;
          startWasSelected = cell.classList.contains("selected");
          
          // Toggle the first cell's selection state
          if (startWasSelected) {
            cell.classList.remove("selected");
          } else {
            cell.classList.add("selected");
          }
        });
        
        // Handle mouse movement over cells
        cell.addEventListener("mousemove", function(event) {
          // Only process if we're in the middle of a drag operation
          if (!isDragging || !startCell) return;
          
          // Prevent text selection during drag
          event.preventDefault();
          
          // If this is a different cell than the last one we processed
          if (cell !== lastHoveredCell) {
            lastHoveredCell = cell;
            
            // Get all cells in the rectangle and update their selection state
            const cellsInRect = getCellsInRectangle(startCell, cell);
            
            // Update all cells in the rectangle to match the starting cell's action (select or deselect)
            cellsInRect.forEach(rectCell => {
              if (startWasSelected) {
                rectCell.classList.remove("selected");
              } else {
                rectCell.classList.add("selected");
              }
            });
          }
        });
      });
      
      // Add mouseup event to document to handle drag end
      document.addEventListener("mouseup", function(event) {
        // Only process if we were dragging
        if (isDragging) {
          isDragging = false;
          startCell = null;
          lastHoveredCell = null;
        }
      });
      
      // Add mouseleave event to table to handle case where mouse leaves the table
      table.addEventListener("mouseleave", function(event) {
        // Only process if we were dragging
        if (isDragging) {
          isDragging = false;
          startCell = null;
          lastHoveredCell = null;
        }
      });
      
      // We don't need a separate click handler - the mousedown already handles toggling
      // The mouseup event will take care of resetting the drag state
      
      // Keep the existing header click handlers
      table.querySelectorAll("th[data-row]").forEach(th => {
        th.addEventListener("click", function() {
          let row = th.getAttribute("data-row");
          let cells = table.querySelectorAll(`td.well[data-well^="${row}"]`);
          let allSelected = true;
          cells.forEach(cell => { if (!cell.classList.contains("selected")) allSelected = false; });
          cells.forEach(cell => { allSelected ? cell.classList.remove("selected") : cell.classList.add("selected"); });
          th.classList.toggle("selected", !allSelected);
        });
      });
      
      table.querySelectorAll("th[data-col]").forEach(th => {
        th.addEventListener("click", function() {
          let col = th.getAttribute("data-col");
          let cells = table.querySelectorAll(`td.well[data-well$="${col}"]`);
          let allSelected = true;
          cells.forEach(cell => { if (!cell.classList.contains("selected")) allSelected = false; });
          cells.forEach(cell => { allSelected ? cell.classList.remove("selected") : cell.classList.add("selected"); });
          th.classList.toggle("selected", !allSelected);
        });
      });
      
      table.querySelector("th.select-all").addEventListener("click", function() {
        let cells = table.querySelectorAll("td.well");
        let allSelected = true;
        cells.forEach(cell => { if (!cell.classList.contains("selected")) allSelected = false; });
        cells.forEach(cell => { allSelected ? cell.classList.remove("selected") : cell.classList.add("selected"); });
        this.classList.toggle("selected", !allSelected);
      });
    }

    /***** Helper Functions for Well Advancement *****/
    function getNextWellId(plateId, currentWell) {
      let wellOrder = [];
      if (plateId.includes("96w")) {
        cols96.forEach(col => { rows96.forEach(row => { wellOrder.push(row + col); }); });
      } else if (plateId.includes("384w")) {
        cols384.forEach(col => { rows384.forEach(row => { wellOrder.push(row + col); }); });
      }
      let index = wellOrder.indexOf(currentWell);
      return (index !== -1 && index < wellOrder.length - 1) ? wellOrder[index + 1] : null;
    }
    function getNextWellIdRowMajor(plateId, currentWell) {
      let wellOrder = [];
      if (plateId.includes("96w")) {
        rows96.forEach(row => { cols96.forEach(col => { wellOrder.push(row + col); }); });
      } else if (plateId.includes("384w")) {
        rows384.forEach(row => { cols384.forEach(col => { wellOrder.push(row + col); }); });
      }
      let index = wellOrder.indexOf(currentWell);
      return (index !== -1 && index < wellOrder.length - 1) ? wellOrder[index + 1] : null;
    }
    function getPlateWellOrder(plateId, orderType) {
      let order = [];
      if (plateId.includes("96w")) {
        if (orderType === "row") { rows96.forEach(row => { cols96.forEach(col => { order.push(row + col); }); }); }
        else { cols96.forEach(col => { rows96.forEach(row => { order.push(row + col); }); }); }
      } else if (plateId.includes("384w")) {
        if (orderType === "row") { rows384.forEach(row => { cols384.forEach(col => { order.push(row + col); }); }); }
        else { cols384.forEach(col => { rows384.forEach(row => { order.push(row + col); }); }); }
      }
      return order;
    }

    /***** Utility Functions for CSV Export *****/
    function headerTextForKey(key) {
      let idx = parseInt(key.split("_")[1]) - 1;
      return layerNames[idx];
    }
    function getVisiblePlate96Ids() {
      let ids = [];
      document.querySelectorAll(".plate96wCheckbox:checked").forEach(cb => { ids.push(cb.value); });
      return ids;
    }
    function determineMetaColumns96() {
      let metaIncluded = {};
      for (let i = 1; i <= 9; i++) { metaIncluded["metadata_" + i] = false; }
      getVisiblePlate96Ids().forEach(plateId => {
        let plate = plate96wData[plateId];
        if (plate) {
          for (let well in plate) {
            for (let i = 1; i <= 9; i++){
              let key = "metadata_" + i;
              if (plate[well][key] && plate[well][key].trim() !== "") {
                metaIncluded[key] = true;
              }
            }
          }
        }
      });
      let included = [];
      for (let i = 1; i <= 9; i++){
        if (metaIncluded["metadata_" + i]) included.push("metadata_" + i);
      }
      return included;
    }
    function getVisiblePlate384Ids() {
      let ids = [];
      document.querySelectorAll(".plate384wCheckbox:checked").forEach(cb => { ids.push(cb.value); });
      return ids;
    }
    function determineMetaColumns384() {
      let metaIncluded = {};
      for (let i = 1; i <= 9; i++) { metaIncluded["metadata_" + i] = false; }
      getVisiblePlate384Ids().forEach(plateId => {
        let plate = plate384wData[plateId];
        if (plate) {
          for (let well in plate) {
            for (let i = 1; i <= 9; i++){
              let key = "metadata_" + i;
              if (plate[well][key] && plate[well][key].trim() !== "") {
                metaIncluded[key] = true;
              }
            }
          }
        }
      });
      let included = [];
      for (let i = 1; i <= 9; i++){
        if (metaIncluded["metadata_" + i]) included.push("metadata_" + i);
      }
      return included;
    }

    /***** The Memory Usage (formerly Rat Cache) *****/
    function updateRatCache() {
      let bytes = JSON.stringify({ plate96wData, plate384wData }).length;
      let display;
      if (bytes < 1024 * 1024) { display = (bytes / 1024).toFixed(2) + " KB"; }
      else { display = (bytes / (1024 * 1024)).toFixed(2) + " MB"; }
      document.getElementById("memoryUsage").textContent = "(" + display + ")";
      if (bytes > 200 * 1024 * 1024) {
        alert("Squeak alert! You're stuffing too much in the nest! Trim down or risk a crash, you data-gobbling vermin!");
      }
    }
    
    setInterval(updateRatCache, 5000);

    /***** Plate Selection & Visibility *****/
    function updatePlateVisibility() {
      const has96w = document.querySelectorAll('.plate96wCheckbox:checked').length > 0;
      const has384w = document.querySelectorAll('.plate384wCheckbox:checked').length > 0;
      
      // Update section visibility
      const section96w = document.getElementById('section96w');
      const section384w = document.getElementById('section384w');
      
      if (has96w) {
        section96w.classList.add('active');
        // Update checkbox labels
        document.querySelectorAll('.plate-checkbox-label[data-plate^="P"][data-plate$="96w"]').forEach(label => {
          if (label.querySelector('input').checked) {
            label.classList.add('active');
          } else {
            label.classList.remove('active');
          }
        });
      } else {
        section96w.classList.remove('active');
      }
      
      if (has384w) {
        section384w.classList.add('active');
        // Update checkbox labels
        document.querySelectorAll('.plate-checkbox-label[data-plate^="P"][data-plate$="384w"]').forEach(label => {
          if (label.querySelector('input').checked) {
            label.classList.add('active');
          } else {
            label.classList.remove('active');
          }
        });
      } else {
        section384w.classList.remove('active');
      }
      
      // Update mapping dropdowns
      updateMappingDropdowns();
    }

    /***** Button Handlers *****/
    // Layer Rename (now uses the same dropdown & input)
    function performLayerRename() {
      let dropdown = document.getElementById("layerDropdown");
      let key = dropdown.value;
      let idx = parseInt(key.split("_")[1]) - 1;
      let newName = document.getElementById("metadataValue").value.trim();
      if (!newName) { alert("Please enter a new layer name."); return; }
      if (!/^[A-Za-z0-9_-]+$/.test(newName)) {
        alert("Invalid layer name. Only letters, numbers, underscores, and dashes are allowed.");
        return;
      }
      layerNames[idx] = newName;
      updateLayerDropdowns();
      dropdown.value = key; // Keep the renamed layer selected.
      document.getElementById("metadataValue").select();
    }
    document.getElementById("renameLayerButton").addEventListener("click", function() {
      performLayerRename();
    });
    
    // Assign Values (with updated whitespace/comma–separated support and auto–advance)
    document.getElementById("assignButton").addEventListener("click", function() {
      let layer = document.getElementById("layerDropdown").value;
      let rawValue = document.getElementById("metadataValue").value;
      let isQuoted = rawValue.startsWith('"') && rawValue.endsWith('"') && rawValue.length >= 2;
      let value;
      if (isQuoted) {
        value = rawValue.substring(1, rawValue.length - 1);
      } else {
        value = rawValue.trim();
      }
      if (!value) { alert("Please enter a metadata value."); return; }
      let selected = document.querySelectorAll("td.well.selected");
      if (selected.length === 0) { alert("No wells selected. Please make a selection."); return; }
      let parsedList;
      if (!isQuoted) {
        parsedList = value.split(/[,\s]+/).filter(s => s !== "");
      } else {
        parsedList = [value];
      }
      if (parsedList.length > 1) {
        if (parsedList.length !== selected.length) {
          alert("Error: Number of values in list (" + parsedList.length +
                ") does not match number of selected wells (" + selected.length + ").");
          return;
        }
        let plateId = selected[0].getAttribute("data-plate");
        for (let cell of selected) {
          if (cell.getAttribute("data-plate") !== plateId) {
            alert("Error: List assignment is only allowed on wells within a single plate.");
            return;
          }
        }
        let orderArray = getPlateWellOrder(plateId, advanceOrder);
        let selectedArray = Array.from(selected);
        selectedArray.sort((a, b) => {
          let wellA = a.getAttribute("data-well");
          let wellB = b.getAttribute("data-well");
          return orderArray.indexOf(wellA) - orderArray.indexOf(wellB);
        });
        saveUndoState();
        for (let i = 0; i < selectedArray.length; i++) {
          let cell = selectedArray[i];
          let wellId = cell.getAttribute("data-well");
          if (plateId.includes("96w")) {
            plate96wData[plateId][wellId][layer] = parsedList[i];
            updateCellDisplay96(cell, plateId, wellId);
          } else {
            plate384wData[plateId][wellId][layer] = parsedList[i];
            updateCellDisplay384(cell, plateId, wellId);
          }
        }
        if (selectedArray.length === 1) {
          let currentWell = selectedArray[0].getAttribute("data-well");
          let nextWell = (advanceOrder === "row") ? getNextWellIdRowMajor(plateId, currentWell) : getNextWellId(plateId, currentWell);
          selectedArray[0].classList.remove("selected");
          if (nextWell) {
            let nextCell = document.querySelector(`td.well[data-plate="${plateId}"][data-well="${nextWell}"]`);
            if (nextCell) nextCell.classList.add("selected");
          } else { clearAllSelections(); }
        } else { clearAllSelections(); }
        document.getElementById("metadataValue").select();
        advanceOrder = "column";
        updateRatCache();
        return;
      }
      let singleSelection = (selected.length === 1);
      let currentPlate, currentWell, nextWell;
      if (singleSelection) {
        let cell = selected[0];
        currentPlate = cell.getAttribute("data-plate");
        currentWell = cell.getAttribute("data-well");
        nextWell = (advanceOrder === "row") ? getNextWellIdRowMajor(currentPlate, currentWell) : getNextWellId(currentPlate, currentWell);
      }
      saveUndoState();
      selected.forEach(cell => {
        let plateId = cell.getAttribute("data-plate");
        let wellId = cell.getAttribute("data-well");
        if (plateId.includes("96w")) {
          plate96wData[plateId][wellId][layer] = value;
          updateCellDisplay96(cell, plateId, wellId);
        } else {
          plate384wData[plateId][wellId][layer] = value;
          updateCellDisplay384(cell, plateId, wellId);
        }
      });
      if (singleSelection) {
        document.querySelectorAll("th.selected").forEach(el => el.classList.remove("selected"));
        selected[0].classList.remove("selected");
        if (nextWell) {
          let nextCell = document.querySelector(`td.well[data-plate="${currentPlate}"][data-well="${nextWell}"]`);
          if (nextCell) nextCell.classList.add("selected");
        } else { clearAllSelections(); }
      } else { clearAllSelections(); }
      document.getElementById("metadataValue").select();
      advanceOrder = "column";
      updateRatCache();
    });
    
    // Clear button: Clear only the metadata value for the currently selected layer for selected wells.
    document.getElementById("clearButton").addEventListener("click", function() {
      let selected = document.querySelectorAll("td.well.selected");
      if (selected.length === 0) {
        alert("No wells selected.");
        return;
      }
      saveUndoState();
      let layer = document.getElementById("layerDropdown").value;
      selected.forEach(cell => {
        let plateId = cell.getAttribute("data-plate");
        let wellId = cell.getAttribute("data-well");
        if (plateId.includes("96w")) {
          plate96wData[plateId][wellId][layer] = "";
          updateCellDisplay96(cell, plateId, wellId);
        } else {
          plate384wData[plateId][wellId][layer] = "";
          updateCellDisplay384(cell, plateId, wellId);
        }
      });
      clearAllSelections();
      updateRatCache();
    });
    
    // Empty 🤮 button: Clear all metadata values across all metadata layers for selected wells.
    document.getElementById("clearAllButton").addEventListener("click", function() {
      let selected = document.querySelectorAll("td.well.selected");
      if (selected.length === 0) {
        alert("No wells selected.");
        return;
      }
      if (confirm("Hey you stinky little cheese hoarder. This will clear all metadata from the selected wells. Useful when things are getting rancid. 🤢 Click \"OK\" to proceed.")) {
        saveUndoState();
        selected.forEach(cell => {
          let plateId = cell.getAttribute("data-plate");
          let wellId = cell.getAttribute("data-well");
          if (plateId.includes("96w")) {
            let data = plate96wData[plateId][wellId];
            for (let i = 1; i <= 9; i++) {
              data["metadata_" + i] = "";
            }
            updateCellDisplay96(cell, plateId, wellId);
          } else {
            let data = plate384wData[plateId][wellId];
            for (let i = 1; i <= 9; i++) {
              data["metadata_" + i] = "";
            }
            updateCellDisplay384(cell, plateId, wellId);
          }
        });
        clearAllSelections();
        updateRatCache();
      }
    });
    
    // Export for 96-well Plates with modified experiment ID handling
    document.getElementById("export96Button").addEventListener("click", function() {
      let experimentId = prompt("Aged cheese needn't mold. Keep it tidy, with an Experiment ID. (Leave blank to skip)");
      let useExperimentId = false;
      
      if (experimentId !== null) {  // User didn't cancel
        if (experimentId && !/^[A-Za-z0-9_-]+$/.test(experimentId)) {
          alert("Invalid Experiment ID. Please enter a valid string of letters, numbers, dashes, or underscores (no spaces).");
          return;
        }
        useExperimentId = experimentId !== ""; // Set to true only if non-empty
      } else {
        return; // User clicked cancel, abort export
      }
      
      let metaCols = determineMetaColumns96();
      let headerMeta = metaCols.map(key => headerTextForKey(key));
      let header = ["sample_id_96w", "Plate_96w", "Well_96w"].concat(headerMeta);
      let csvContent = header.map(h => `"${h}"`).join(",") + "\n";
      
      document.querySelectorAll(".plate96wCheckbox:checked").forEach(cb => {
        let plateId = cb.value;
        let newPlateId = useExperimentId ? experimentId + "_" + plateId : plateId;
        let data = plate96wData[plateId];
        
        cols96.forEach(col => {
          rows96.forEach(row => {
            let wellId = row + col;
            let d = data[wellId];
            let sampleId = newPlateId + "_" + wellId;
            let rowArray = [sampleId, newPlateId, wellId];
            metaCols.forEach(key => { rowArray.push(d[key]); });
            csvContent += rowArray.map(item => `"${item}"`).join(",") + "\n";
          });
        });
      });
      
      let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      let url = URL.createObjectURL(blob);
      let link = document.createElement("a");
      link.setAttribute("href", url);
      let filename = useExperimentId ? experimentId + "_plate96w_metadata.csv" : "plate96w_metadata.csv";
      link.setAttribute("download", filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Export for 384-well Plates with modified experiment ID handling
    document.getElementById("export384Button").addEventListener("click", function() {
      let experimentId = prompt("Aged cheese needn't mold. Keep it tidy, with an Experiment ID. (Leave blank to skip)");
      let useExperimentId = false;
      
      if (experimentId !== null) {  // User didn't cancel
        if (experimentId && !/^[A-Za-z0-9_-]+$/.test(experimentId)) {
          alert("Invalid Experiment ID. Please enter a valid string of letters, numbers, dashes, or underscores (no spaces).");
          return;
        }
        useExperimentId = experimentId !== ""; // Set to true only if non-empty
      } else {
        return; // User clicked cancel, abort export
      }
      
      let metaCols = determineMetaColumns384();
      let mappingUsed = false;
      
      document.querySelectorAll(".plate384wCheckbox:checked").forEach(cb => {
        let plateId = cb.value;
        let data = plate384wData[plateId];
        for (let well in data) {
          let d = data[well];
          if ((d.Src_Plate_96w && d.Src_Plate_96w.trim() !== "") || (d.Src_Well_96w && d.Src_Well_96w.trim() !== "")) {
            mappingUsed = true;
            break;
          }
        }
      });
      
      let headerMeta = metaCols.map(key => headerTextForKey(key));
      let header;
      
      if (mappingUsed) {
        header = ["sample_id_384w", "Plate_384w", "Well_384w", "Plate_384w_Quad", "sample_id_96w", "Src_Plate_96w", "Src_Well_96w"].concat(headerMeta);
      } else {
        header = ["sample_id_384w", "Plate_384w", "Well_384w", "Plate_384w_Quad"].concat(headerMeta);
      }
      
      let csvContent = header.map(h => `"${h}"`).join(",") + "\n";
      
      document.querySelectorAll(".plate384wCheckbox:checked").forEach(cb => {
        let plateId = cb.value;
        let newPlateId = useExperimentId ? experimentId + "_" + plateId : plateId;
        let data = plate384wData[plateId];
        
        cols384.forEach((col, colIndex) => {
          rows384.forEach((row, rowIndex) => {
            let wellId = row + col;
            let rnum = rowIndex + 1, cnum = colIndex + 1;
            let quadrant;
            
            if (rnum % 2 === 1 && cnum % 2 === 1) quadrant = "Q1";
            else if (rnum % 2 === 0 && cnum % 2 === 1) quadrant = "Q2";
            else if (rnum % 2 === 1 && cnum % 2 === 0) quadrant = "Q3";
            else quadrant = "Q4";
            
            let fullQuad = newPlateId + "_" + quadrant;
            let d = data[wellId];
            let sampleId384w = newPlateId + "_" + wellId;
            let rowArray = [sampleId384w, newPlateId, wellId, fullQuad];
            
            if (mappingUsed) {
              let sampleId96w = "";
              let newSrcPlate = "";
              
              if (d.Src_Plate_96w && d.Src_Well_96w) {
                newSrcPlate = useExperimentId ? experimentId + "_" + d.Src_Plate_96w : d.Src_Plate_96w;
                sampleId96w = newSrcPlate + "_" + d.Src_Well_96w;
              }
              
              rowArray.push(sampleId96w, newSrcPlate, d.Src_Well_96w);
            }
            
            metaCols.forEach(key => { rowArray.push(d[key]); });
            csvContent += rowArray.map(item => `"${item}"`).join(",") + "\n";
          });
        });
      });
      
      let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      let url = URL.createObjectURL(blob);
      let link = document.createElement("a");
      link.setAttribute("href", url);
      let filename = useExperimentId ? experimentId + "_plate384w_metadata.csv" : "plate384w_metadata.csv";
      link.setAttribute("download", filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    
    // Mapping to Quadrant (Map Wells)
    document.getElementById("mapButton").addEventListener("click", function() {
      clearAllSelections();
      let srcPlate = document.getElementById("srcPlateSelect").value;
      let destQuadrant = document.getElementById("destQuadSelect").value;
      if (!srcPlate || !destQuadrant) {
        alert("Please select both a source 96-well plate and a destination quadrant.");
        return;
      }
      saveUndoState();
      let parts = destQuadrant.split("_Q");
      let destPlate = parts[0];
      let quadNum = parts[1];
      let srcWells = [];
      cols96.forEach(col => { rows96.forEach(row => { srcWells.push(row + col); }); });
      let destWells = [];
      cols384.forEach(col => { 
        rows384.forEach(row => {
          let rowIndex = rows384.indexOf(row) + 1;
          let colIndex = cols384.indexOf(col) + 1;
          let rowOk = (quadNum === "1" || quadNum === "3") ? (rowIndex % 2 === 1) : (rowIndex % 2 === 0);
          let colOk = (quadNum === "1" || quadNum === "2") ? (colIndex % 2 === 1) : (colIndex % 2 === 0);
          if (rowOk && colOk) destWells.push(row + col);
        });
      });
      destWells.sort((a, b) => {
        let aRow = a.charAt(0), bRow = b.charAt(0);
        let aCol = a.slice(1), bCol = b.slice(1);
        if (aCol === bCol) return rows384.indexOf(aRow) - rows384.indexOf(bRow);
        return parseInt(aCol) - parseInt(bCol);
      });
      if (srcWells.length !== 96 || destWells.length !== 96) {
        alert("Unexpected error: number of wells mismatch.");
        return;
      }
      let srcData = plate96wData[srcPlate];
      let destData = plate384wData[destPlate];
      for (let i = 0; i < 96; i++) {
        let srcWell = srcWells[i];
        let destWell = destWells[i];
        destData[destWell] = {};
        for (let j = 1; j <= 9; j++) { destData[destWell]["metadata_" + j] = ""; }
        destData[destWell].Src_Plate_96w = "";
        destData[destWell].Src_Well_96w = "";
        for (let j = 1; j <= 9; j++) {
          let key = "metadata_" + j;
          if (srcData[srcWell][key]) { destData[destWell][key] = srcData[srcWell][key]; }
        }
        destData[destWell].Src_Plate_96w = srcPlate;
        destData[destWell].Src_Well_96w = srcWell;
        let srcCell = document.querySelector(`td.well[data-plate="${srcPlate}"][data-well="${srcWell}"]`);
        if (srcCell) srcCell.classList.add("selected");
        let destCell = document.querySelector(`td.well[data-plate="${destPlate}"][data-well="${destWell}"]`);
        if (destCell) {
          updateCellDisplay384(destCell, destPlate, destWell);
          destCell.classList.add("selected");
        }
      }
      document.querySelectorAll("th.selected").forEach(el => el.classList.remove("selected"));
      updateRatCache();
    });
    
    /***** Checkbox Handlers for Showing/Hiding Plates *****/
    document.querySelectorAll(".plate96wCheckbox").forEach(cb => {
      cb.addEventListener("change", function() {
        let plateId = cb.value;
        let container = document.getElementById("plate96wContainer");
        
        // Update checkbox label class
        const label = document.querySelector(`.plate-checkbox-label[data-plate="${plateId}"]`);
        if (this.checked) {
          label.classList.add('active');
        } else {
          label.classList.remove('active');
        }
        
        if (cb.checked) {
          if (!plate96wData[plateId]) initPlate96(plateId);
          let table = generate96PlateTable(plateId);
          addSelectionHandlers(table);
          let plateDiv = document.createElement("div");
          plateDiv.className = "plateWrapper";
          plateDiv.id = plateId;
          let label = document.createElement("h3");
          label.textContent = plateId;
          plateDiv.appendChild(label);
          let tableContainer = document.createElement("div");
          tableContainer.className = "plate-table-container";
          tableContainer.appendChild(table);
          plateDiv.appendChild(tableContainer);
          container.appendChild(plateDiv);
        } else {
          let plateDiv = document.getElementById(plateId);
          if (plateDiv) plateDiv.remove();
        }
        updatePlateVisibility();
      });
    });
    document.querySelectorAll(".plate384wCheckbox").forEach(cb => {
      cb.addEventListener("change", function() {
        let plateId = cb.value;
        let container = document.getElementById("plate384wContainer");
        
        // Update checkbox label class
        const label = document.querySelector(`.plate-checkbox-label[data-plate="${plateId}"]`);
        if (this.checked) {
          label.classList.add('active');
        } else {
          label.classList.remove('active');
        }
        
        if (cb.checked) {
          if (!plate384wData[plateId]) initPlate384(plateId);
          let table = generate384PlateTable(plateId);
          addSelectionHandlers(table);
          let plateDiv = document.createElement("div");
          plateDiv.className = "plateWrapper";
          plateDiv.id = plateId;
          let label = document.createElement("h3");
          label.textContent = plateId;
          plateDiv.appendChild(label);
          let tableContainer = document.createElement("div");
          tableContainer.className = "plate-table-container";
          tableContainer.appendChild(table);
          plateDiv.appendChild(tableContainer);
          container.appendChild(plateDiv);
        } else {
          let plateDiv = document.getElementById(plateId);
          if (plateDiv) plateDiv.remove();
        }
        updatePlateVisibility();
      });
    });
    function updateMappingDropdowns() {
      let srcSelect = document.getElementById("srcPlateSelect");
      srcSelect.innerHTML = "";
      document.querySelectorAll(".plate96wCheckbox:checked").forEach(cb => {
        let opt = document.createElement("option");
        opt.value = cb.value;
        opt.textContent = cb.value;
        srcSelect.appendChild(opt);
      });
      let destSelect = document.getElementById("destQuadSelect");
      destSelect.innerHTML = "";
      document.querySelectorAll(".plate384wCheckbox:checked").forEach(cb => {
        let plateId = cb.value;
        for (let q = 1; q <= 4; q++) {
          let opt = document.createElement("option");
          opt.value = plateId + "_Q" + q;
          opt.textContent = plateId + "_Q" + q;
          destSelect.appendChild(opt);
        }
      });
    }
    
    /***** Enter-Key Handler for Metadata Value Input *****/
    document.getElementById("metadataValue").addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        if (event.shiftKey && event.altKey) {
          // Shift+Alt+Enter (or Shift+Option+Enter on Mac) performs layer rename.
          performLayerRename();
        } else {
          advanceOrder = event.shiftKey ? "row" : "column";
          document.getElementById("assignButton").click();
        }
      }
    });
    
    /***** Deselect All / Visualize Button Handler *****/
    document.getElementById("deselectAllButton").addEventListener("click", function() {
      if (isMetadataOverlayMode) {
        exitMetadataOverlayMode();
      } else {
        applyMetadataVisualization();
      }
    });
    
    /***** Undo Button Handler *****/
    document.getElementById("undoButton").addEventListener("click", function() {
      undoLastAction();
    });

    /***** Keyboard Shortcuts *****/
    document.addEventListener("keydown", function(e) {
      const isMac = /Mac|iPod|iPhone|iPad/.test(navigator.platform);
      
      // Toggle shortcuts help popup with Ctrl/Cmd + /
      if ((isMac ? e.metaKey : e.ctrlKey) && e.key === '/') {
        e.preventDefault();
        toggleShortcutsPopup();
        return;
      }
      
      // Close shortcuts popup with Escape
      if (e.key === 'Escape' && document.getElementById('shortcutsPopup').classList.contains('active')) {
        e.preventDefault();
        closeShortcutsPopup();
        return;
      }
      
      // Plate toggling: Ctrl/Cmd + Alt [+ Shift] + [Digit]
      if ((isMac ? e.metaKey : e.ctrlKey) && e.altKey) {
        const plateMapping = {
          "Digit1": "P01_96w",
          "Digit2": "P02_96w",
          "Digit3": "P03_96w",
          "Digit4": "P04_96w",
          "Digit5": "P05_96w",
          "Digit6": "P06_96w",
          "Digit7": "P07_96w",
          "Digit8": "P08_96w",
          "Digit9": "P01_384w",
          "Digit0": "P02_384w"
        };
        if (e.code in plateMapping) {
          let plateId = plateMapping[e.code];
          if (e.shiftKey) {
            // Simulate click on plate's select-all header.
            let table = document.querySelector('table.plateTable[data-plate="'+plateId+'"]');
            if (table) {
              let thSelectAll = table.querySelector('th.select-all');
              if (thSelectAll) { thSelectAll.click(); }
            }
          } else {
            // Toggle the plate checkbox.
            let checkbox;
            if (plateId.includes("96w")) {
              checkbox = document.querySelector('input.plate96wCheckbox[value="'+plateId+'"]');
            } else {
              checkbox = document.querySelector('input.plate384wCheckbox[value="'+plateId+'"]');
            }
            if (checkbox) {
              checkbox.checked = !checkbox.checked;
              checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
          e.preventDefault();
          return;
        }
      }
      
      // Other shortcuts: Ctrl/Cmd + Shift (without Alt)
      if ((isMac ? e.metaKey : e.ctrlKey) && e.shiftKey && !e.altKey) {
        let key = e.key.toLowerCase();
        if (key === 'l' || key === 'm') {
          e.preventDefault();
          let input = document.getElementById("metadataValue");
          input.focus();
          input.select();
        } else if (key === 's') {
          e.preventDefault();
          let srcSelect = document.getElementById("srcPlateSelect");
          srcSelect.focus();
        } else if (key === 'd') {
          e.preventDefault();
          let destSelect = document.getElementById("destQuadSelect");
          destSelect.focus();
        } else if (key === 'o') {
          e.preventDefault();
          let export96 = document.getElementById("export96Button");
          export96.focus();
        } else if (key === 'p') {
          e.preventDefault();
          let export384 = document.getElementById("export384Button");
          export384.focus();
        }
      }
    });
    
    /***** Shortcuts Popup Functions *****/
    function toggleShortcutsPopup() {
      const popup = document.getElementById('shortcutsPopup');
      const overlay = document.getElementById('shortcutsOverlay');
      
      if (popup.classList.contains('active')) {
        closeShortcutsPopup();
      } else {
        popup.classList.add('active');
        overlay.classList.add('active');
      }
    }
    
    function closeShortcutsPopup() {
      const popup = document.getElementById('shortcutsPopup');
      const overlay = document.getElementById('shortcutsOverlay');
      
      popup.classList.remove('active');
      overlay.classList.remove('active');
    }
    
    // Event listeners for shortcuts popup
    document.getElementById('shortcutsClose').addEventListener('click', closeShortcutsPopup);
    document.getElementById('shortcutsOverlay').addEventListener('click', closeShortcutsPopup);
    
    /***** Prevent accidental refresh *****/
    window.addEventListener('beforeunload', function(e) {
      // This exact message might not be shown in modern browsers - they use their own standard messages
      // But the browser will still display a confirmation dialog
      const confirmationMessage = "Oi, you rancid, poopy-smelling vermin! Got too excited, did ya? Click \"OK,\" and poof—all your precious metadata's gone. No take-backs. Now scram before your stink lingers! 🪤";
      
      // Modern standard way to trigger the confirmation dialog
      e.preventDefault();
      e.returnValue = confirmationMessage;
      
      // For older browsers
      return confirmationMessage;
    });
  </script>
</body>
</html>